<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K10 Admin - Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

    <script src="admin-navbar.js"></script>

    <div class="max-w-[95%] mx-auto px-4 mt-8 pb-12">
        <div class="flex flex-col lg:flex-row gap-8">
            
            <div class="w-full lg:w-1/4 space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border-t-4 border-blue-600 sticky top-24">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">üîç Filter Inventory</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Search</label>
                            <input type="text" id="filter-search" placeholder="Name, Barcode, or ID..." class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Game Title</label>
                            <select id="filter-game" class="w-full p-2 border rounded bg-gray-50">
                                <option value="">All Games</option>
                                <option value="One Piece">One Piece</option>
                                <option value="Pokemon">Pokemon</option>
                                <option value="Hololive">Hololive</option>
                                <option value="Digimon">Digimon</option>
                                <option value="Dragon Ball">Dragon Ball</option>
                                <option value="Union Arena">Union Arena</option>
                                <option value="Accessories">Accessories</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Category</label>
                            <select id="filter-category" class="w-full p-2 border rounded bg-gray-50">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="w-full lg:w-3/4 space-y-6">

                <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-green-500">
                    <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="toggleAddForm()">
                        <h2 class="text-lg font-bold text-gray-800">‚ûï Add New Product</h2>
                        <span id="form-toggle-icon" class="text-gray-400 text-sm">‚ñº</span>
                    </div>
                    
                    <div id="add-product-form" class="hidden">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Game</label>
                                <select id="add-game" class="w-full p-2 border rounded text-sm">
                                    <option value="One Piece">One Piece</option>
                                    <option value="Pokemon">Pokemon</option>
                                    <option value="Hololive">Hololive</option>
                                    <option value="Digimon">Digimon</option>
                                    <option value="Dragon Ball">Dragon Ball</option>
                                    <option value="Union Arena">Union Arena</option>
                                    <option value="Accessories">Accessories</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Category *</label>
                                <select id="add-category" onchange="toggleConfigFields()" class="w-full p-2 border rounded text-sm font-bold">
                                    <option value="">Loading categories...</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Barcode</label>
                                <input type="text" id="add-barcode" class="w-full p-2 border rounded text-sm">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Set/Card ID</label>
                                <input type="text" id="add-id" placeholder="OP01-001" class="w-full p-2 border rounded text-sm">
                            </div>
                        </div>

                        <div id="ratio-config" class="hidden bg-blue-50 p-3 rounded mb-4 border border-blue-200">
                            <h4 class="text-[10px] font-bold text-blue-700 uppercase mb-2">‚öôÔ∏è Unit Configuration (For Boxes/Packs)</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500">Packs per Box</label>
                                    <input type="number" id="add-ppb" value="24" class="w-full p-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500">Boxes per Case</label>
                                    <input type="number" id="add-bpc" value="12" class="w-full p-1 border rounded text-sm">
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="add-name" placeholder="Product Name *" class="w-full p-2 border rounded text-sm font-bold">
                            <div class="grid grid-cols-3 gap-2">
                                <input type="number" id="add-cost" placeholder="Cost ($)" class="w-full p-2 border rounded text-sm bg-gray-50">
                                <input type="number" id="add-price" placeholder="Sell ($)" class="w-full p-2 border rounded text-sm">
                                <input type="number" id="add-stock" placeholder="Total Packs" class="w-full p-2 border rounded text-sm font-bold">
                            </div>
                        </div>
                        <div class="text-right">
                            <button onclick="addProduct()" class="bg-green-600 hover:bg-green-700 text-white font-bold px-6 py-2 rounded shadow transition active:scale-95">
                                Save Product
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm overflow-hidden min-h-[600px]">
                    <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                        <span class="text-xs font-bold text-gray-500 uppercase" id="result-count">0 Items Found</span>
                        <button onclick="loadInventory()" class="text-blue-600 text-xs font-bold hover:underline">‚Üª Refresh</button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-white border-b text-xs uppercase font-bold text-gray-400">
                                <tr>
                                    <th class="p-4">Product Details</th>
                                    <th class="p-4">Category</th>
                                    <th class="p-4 text-right">Price</th>
                                    <th class="p-4">Stock Breakdown</th>
                                    <th class="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body"></tbody>
                        </table>
                    </div>
                    <div id="loading" class="p-12 text-center text-gray-500 font-bold">‚è≥ Loading Inventory...</div>
                    <div id="empty-state" class="p-12 text-center text-gray-400 hidden">No items match your filters.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://k10system.onrender.com/api';
        let globalInventory = [];
        let categories = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('k10_token');
            if (!token) window.location.href = 'admin.html';
            
            await loadCategories();
            await loadInventory();
            
            document.getElementById('filter-search').addEventListener('keyup', applyFilters);
            document.getElementById('filter-game').addEventListener('change', applyFilters);
            document.getElementById('filter-category').addEventListener('change', applyFilters);
        });

        async function loadCategories() {
            try {
                const res = await fetch(`${API_URL}/categories`);
                categories = await res.json();
                
                // Populate Add Form dropdown
                const addSelect = document.getElementById('add-category');
                addSelect.innerHTML = '<option value="">-- Select Type --</option>' + 
                    categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                
                // Populate Filter dropdown
                const filterSelect = document.getElementById('filter-category');
                filterSelect.innerHTML = '<option value="">All Categories</option>' + 
                    categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            } catch (e) { console.error("Failed to load categories"); }
        }

        function toggleConfigFields() {
            const catId = document.getElementById('add-category').value;
            const catName = categories.find(c => c.id == catId)?.name || "";
            const configDiv = document.getElementById('ratio-config');
            
            // Show config for box/pack categories
            if (catName.includes('Box') || catName.includes('Pack')) {
                configDiv.classList.remove('hidden');
            } else {
                configDiv.classList.add('hidden');
            }
        }

        async function loadInventory() {
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            
            try {
                const res = await fetch(`${API_URL}/inventory/status`);
                globalInventory = await res.json();
                applyFilters();
                loading.classList.add('hidden');
            } catch (e) { loading.innerText = "Error loading data."; }
        }

        function applyFilters() {
            const search = document.getElementById('filter-search').value.toLowerCase();
            const game = document.getElementById('filter-game').value;
            const catId = document.getElementById('filter-category').value;

            const filtered = globalInventory.filter(p => {
                const matchSearch = !search || p.card_name.toLowerCase().includes(search);
                const matchGame = !game || p.game_title === game;
                const matchCat = !catId || p.category_id == catId;
                return matchSearch && matchGame && matchCat;
            });
            
            renderTable(filtered);
        }

        function renderTable(items) {
            const tbody = document.getElementById('inventory-table-body');
            const empty = document.getElementById('empty-state');
            document.getElementById('result-count').innerText = `${items.length} Items Found`;

            if (items.length === 0) {
                tbody.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            tbody.innerHTML = items.map(p => {
                let stockUI = `<span class="font-bold text-gray-800">${p.stock_quantity}</span>`;
                
                // Smart conversion display for specific categories
                if (p.packs_per_box > 1 && p.stock_quantity > 0) {
                    const ppb = p.packs_per_box;
                    const bpc = p.boxes_per_case || 1;
                    const fullBoxes = Math.floor(p.stock_quantity / ppb);
                    const leftPacks = p.stock_quantity % ppb;
                    const fullCases = Math.floor(fullBoxes / bpc);
                    const leftBoxes = fullBoxes % bpc;
                    
                    stockUI = `
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-gray-800">${p.stock_quantity} Total Packs</span>
                            <span class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-0.5 rounded mt-1 border border-blue-100 w-fit">
                                üì¶ ${fullCases}C, ${leftBoxes}B, ${leftPacks}P
                            </span>
                        </div>`;
                }

                return `
                <tr class="border-b hover:bg-gray-50 transition text-sm">
                    <td class="p-4">
                        <div class="font-bold text-gray-800">${p.card_name}</div>
                        <div class="text-[10px] text-gray-400 font-mono">ID: ${p.card_id || '-'}</div>
                    </td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded text-[10px] font-bold uppercase bg-gray-100 text-gray-600">
                            ${p.game_title} ‚Ä¢ ${p.category_name || 'Uncategorized'}
                        </span>
                    </td>
                    <td class="p-4 text-right font-bold text-gray-700">$${parseFloat(p.price).toFixed(2)}</td>
                    <td class="p-4">${stockUI}</td>
                    <td class="p-4 text-right">
                        <button onclick="deleteProduct(${p.id})" class="text-red-400 hover:text-red-600 font-bold text-xs">Delete</button>
                    </td>
                </tr>`;
            }).join('');
        }

        async function addProduct() {
            const data = {
                category_id: document.getElementById('add-category').value,
                game_title: document.getElementById('add-game').value,
                card_name: document.getElementById('add-name').value,
                price: document.getElementById('add-price').value,
                cost_price: document.getElementById('add-cost').value,
                stock_quantity: document.getElementById('add-stock').value,
                barcode: document.getElementById('add-barcode').value,
                card_id: document.getElementById('add-id').value,
                packs_per_box: document.getElementById('add-ppb').value || 1,
                boxes_per_case: document.getElementById('add-bpc').value || 1
            };

            if (!data.category_id || !data.card_name) return alert("Category and Product Name are required");

            try {
                const res = await fetch(`${API_URL}/inventory/add`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(data) 
                });
                if (res.ok) {
                    alert("‚úÖ Product Added!");
                    document.getElementById('add-name').value = '';
                    loadInventory(); 
                }
            } catch (e) { alert("Connection Error"); }
        }

        async function deleteProduct(id) {
            if(confirm("Confirm deletion?")) {
                await fetch(`${API_URL}/inventory/${id}`, { method: 'DELETE' });
                loadInventory();
            }
        }

        function toggleAddForm() {
            document.getElementById('add-product-form').classList.toggle('hidden');
        }
    </script>
</body>
</html>
