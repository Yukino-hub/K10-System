<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K10 Admin - Purchase Orders</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <script src="admin-navbar.js"></script>

    <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-3 gap-8 pb-12 mt-8">
        
        <div class="lg:col-span-1 space-y-6">
            
            <div class="bg-white p-6 rounded-lg shadow-sm border-t-4 border-blue-600">
                <h2 class="text-lg font-bold mb-4">1. Order Details</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">PO Number</label>
                        <input type="text" id="po-number" placeholder="Leave blank for auto-gen" 
                               class="w-full p-2 border rounded bg-gray-50 font-mono text-blue-600 font-bold mt-1 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Supplier</label>
                        <select id="supplier-select" class="w-full p-2 border rounded mt-1 font-bold text-gray-700 outline-none">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm border-t-4 border-green-600">
                <h2 class="text-lg font-bold mb-4">2. Financial Recording</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Payment Strategy</label>
                        <select id="po-payment-status" onchange="toggleFinancialInputs()" class="w-full p-2 border rounded mt-1 font-bold text-gray-700">
                            <option value="Pending Invoice">Preorder (Pay on Invoice)</option>
                            <option value="Partial Deposit">Partial Deposit</option>
                            <option value="Fully Paid">Immediate Full Payment</option>
                        </select>
                    </div>
                    
                    <div id="deposit-input-group" class="hidden">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Deposit Amount ($)</label>
                        <input type="number" id="po-deposit" step="0.01" oninput="updateSpendDisplay()" 
                               class="w-full p-2 border rounded bg-yellow-50 font-bold text-orange-700 outline-none">
                    </div>

                    <div class="pt-2 border-t flex justify-between items-center">
                        <span class="text-xs font-bold text-gray-500 uppercase">Actual Money Out:</span>
                        <span id="actual-spend" class="text-xl font-bold text-red-600">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-lg font-bold mb-4">3. Add Products</h2>
                <div class="relative">
                    <input type="text" id="item-search" placeholder="Search card or box name..." 
                           class="w-full p-3 border-2 border-blue-50 rounded-lg outline-none focus:border-blue-500 transition-all text-sm">
                    <div id="search-results" class="absolute top-full left-0 w-full bg-white shadow-2xl border rounded-b-lg z-50 max-h-80 overflow-y-auto hidden"></div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-sm overflow-hidden flex flex-col min-h-[600px]">
                <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                    <h2 class="text-lg font-bold">4. Items in this Order</h2>
                    <span id="item-count" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-[10px] font-bold uppercase">0 Items</span>
                </div>
                
                <div class="flex-grow overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-white border-b text-[10px] font-bold text-gray-400 uppercase tracking-widest">
                            <tr>
                                <th class="p-4">Product</th>
                                <th class="p-4 w-24 text-center">Qty</th>
                                <th class="p-4 w-32 text-right">Unit Cost ($)</th>
                                <th class="p-4 w-12"></th>
                            </tr>
                        </thead>
                        <tbody id="po-items-table"></tbody>
                    </table>
                    <div id="empty-state" class="p-24 text-center text-gray-300 italic">No items added to order.</div>
                </div>

                <div class="p-6 bg-gray-50 border-t flex flex-col items-end">
                    <div class="mb-4 text-right">
                        <span class="text-xs font-bold text-gray-400 uppercase block mb-1">Total Order Value</span>
                        <span id="order-total" class="text-3xl font-bold text-blue-600">$0.00</span>
                    </div>
                    <button onclick="submitPO()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-lg hover:bg-blue-700 shadow-lg transition-all active:scale-[0.98]">
                        Finalize & Save Purchase Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://k10system.onrender.com/api';
        let basket = [];

        document.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('k10_token')) window.location.href = 'admin.html';
            loadSuppliers();
            setupSearch();
        });

        async function loadSuppliers() {
            try {
                const res = await fetch(`${API_URL}/suppliers`);
                const data = await res.json();
                document.getElementById('supplier-select').innerHTML = data.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            } catch (e) { console.error("Supplier Load Error"); }
        }

        function toggleFinancialInputs() {
            const status = document.getElementById('po-payment-status').value;
            document.getElementById('deposit-input-group').classList.toggle('hidden', status !== 'Partial Deposit');
            updateSpendDisplay();
        }

        function updateSpendDisplay() {
            const status = document.getElementById('po-payment-status').value;
            const deposit = parseFloat(document.getElementById('po-deposit').value) || 0;
            const total = basket.reduce((sum, item) => sum + (item.qty * item.cost), 0);
            
            let spend = 0;
            if (status === 'Fully Paid') spend = total;
            if (status === 'Partial Deposit') spend = deposit;
            
            document.getElementById('order-total').innerText = `$${total.toFixed(2)}`;
            document.getElementById('actual-spend').innerText = `$${spend.toFixed(2)}`;
        }

        function setupSearch() {
            const input = document.getElementById('item-search');
            input.addEventListener('input', async (e) => {
                const query = e.target.value;
                if (query.length < 2) return document.getElementById('search-results').classList.add('hidden');
                
                try {
                    const res = await fetch(`${API_URL}/inventory/status`);
                    const items = await res.json();
                    const filtered = items.filter(i => i.card_name.toLowerCase().includes(query.toLowerCase()));
                    
                    const resultsDiv = document.getElementById('search-results');
                    resultsDiv.innerHTML = filtered.map(i => `
                        <div class="p-3 hover:bg-blue-50 cursor-pointer border-b" onclick='addToBasket(${JSON.stringify(i)})'>
                            <div class="font-bold text-sm">${i.card_name}</div>
                            <div class="text-[10px] text-gray-400 uppercase">
                                ${i.game_title} • ${i.category_name || 'Item'} </div>
                        </div>`).join('') || `<div class="p-4 text-center italic text-gray-400 text-xs">No products found.</div>`;
                    resultsDiv.classList.remove('hidden');
                } catch (e) { console.error("Search Error"); }
            });
        }

        function addToBasket(item) {
            if (basket.find(b => b.inventory_id === item.id)) return;
            basket.push({ 
                inventory_id: item.id, 
                name: item.card_name, 
                cost: parseFloat(item.cost_price || 0), 
                qty: 1 
            });
            renderBasket();
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('item-search').value = '';
        }

        function renderBasket() {
            const tbody = document.getElementById('po-items-table');
            document.getElementById('empty-state').classList.toggle('hidden', basket.length > 0);
            document.getElementById('item-count').innerText = `${basket.length} Items`;
            
            tbody.innerHTML = basket.map((item, idx) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-bold text-sm">${item.name}</td>
                    <td class="p-4"><input type="number" value="${item.qty}" min="1" onchange="basket[${idx}].qty = parseInt(this.value); renderBasket()" class="w-16 border rounded text-center"></td>
                    <td class="p-4"><input type="number" step="0.01" value="${item.cost.toFixed(2)}" onchange="basket[${idx}].cost = parseFloat(this.value); renderBasket()" class="w-full border rounded text-right p-1 font-mono"></td>
                    <td class="p-4 text-center text-red-500 cursor-pointer font-bold" onclick="basket.splice(${idx}, 1); renderBasket()">×</td>
                </tr>`).join('');
            updateSpendDisplay();
        }

        async function submitPO() {
            if (basket.length === 0) return alert("Your order basket is empty!");
            const total = basket.reduce((sum, item) => sum + (item.qty * item.cost), 0);
            const status = document.getElementById('po-payment-status').value;
            const deposit = parseFloat(document.getElementById('po-deposit').value) || 0;

            const payload = {
                supplier_id: document.getElementById('supplier-select').value,
                po_number: document.getElementById('po-number').value,
                payment_status: status,
                total_cost: total,
                deposit_paid: deposit,
                paid_amount: status === 'Fully Paid' ? total : (status === 'Partial Deposit' ? deposit : 0),
                items: basket.map(i => ({ inventory_id: i.inventory_id, qty: i.qty, cost: i.cost }))
            };

            const btn = document.querySelector('button[onclick="submitPO()"]');
            btn.disabled = true;
            btn.innerText = "Processing Order...";

            try {
                const res = await fetch(`${API_URL}/purchase-orders`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res.ok) { 
                    alert("✅ Purchase Order Saved Successfully!"); 
                    location.reload(); 
                } else {
                    alert("❌ Error saving Purchase Order.");
                    btn.disabled = false;
                    btn.innerText = "Finalize & Save Purchase Order";
                }
            } catch (e) { 
                alert("❌ Connection Error."); 
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
