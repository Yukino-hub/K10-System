<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K10 Admin - Point of Sale</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

    <script src="admin-navbar.js"></script>

    <div class="max-w-7xl mx-auto px-4 mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8 pb-12">
        
        <div class="space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-sm border-t-4 border-blue-600">
                <h2 class="text-lg font-bold mb-4 text-gray-700">1. Order Type</h2>
                <div class="flex bg-gray-100 p-1 rounded-lg mb-4">
                    <button onclick="setOrderType('In-Stock')" id="btn-instock" class="flex-1 py-2 rounded-md text-sm font-bold shadow bg-white text-blue-600 transition">
                        üì¶ In-Stock Buy
                    </button>
                    <button onclick="setOrderType('Preorder')" id="btn-preorder" class="flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-gray-700 transition">
                        ‚è≥ Preorder
                    </button>
                </div>
                <p id="mode-desc" class="text-xs text-gray-400 italic">Deducts from inventory immediately.</p>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-lg font-bold mb-4 text-gray-700">2. Customer</h2>
                <div class="relative mb-4" id="cust-search-container">
                    <input type="text" id="cust-search" placeholder="Search Name or Mobile..." 
                           class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    <div id="cust-results" class="absolute z-20 w-full bg-white shadow-xl border rounded mt-1 hidden max-h-48 overflow-y-auto"></div>
                </div>

                <div id="cust-card" class="hidden bg-blue-50 p-4 rounded border border-blue-100 relative">
                    <div class="font-bold text-blue-800" id="card-name">Customer Name</div>
                    <div class="text-xs text-blue-600 mb-1" id="card-info">Contact Info</div>
                    <span id="cust-points-badge" class="bg-blue-200 text-blue-800 text-[10px] px-2 py-0.5 rounded-full font-bold">0 Pts</span>
                    <button onclick="clearCustomer()" class="absolute top-2 right-2 text-red-400 hover:text-red-600 font-bold text-xs">Change</button>
                    <input type="hidden" id="selected-cust-id">
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-lg font-bold mb-4 text-gray-700">3. Payment</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Payment Method</label>
                        <select id="payment-method" class="w-full p-2 border rounded bg-gray-50 font-bold text-gray-700">
                            <option value="Cash">üíµ Cash</option>
                            <option value="PayNow">üì± PayNow / QR</option>
                            <option value="Credit Card">üí≥ Credit Card</option>
                            <option value="Store Credit">üè¶ Store Credit</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Payment Status</label>
                        <select id="payment-status-select" onchange="toggleDepositInput()" class="w-full p-2 border rounded bg-blue-50 font-bold text-blue-900">
                            <option value="Paid">‚úÖ Full Payment</option>
                            <option value="Partial">‚ö†Ô∏è Deposit / Partial</option>
                            <option value="Pending">‚è≥ Pay Later</option>
                        </select>
                    </div>

                    <div id="deposit-box" class="hidden">
                        <label class="text-xs font-bold text-gray-500 uppercase">Deposit Amount ($)</label>
                        <input type="number" id="deposit-amount" placeholder="0.00" class="w-full p-2 border-2 border-yellow-400 rounded bg-yellow-50 font-bold text-lg">
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-sm min-h-[600px] flex flex-col">
                <h2 class="text-lg font-bold mb-4 text-gray-700">4. Add Items</h2>
                
                <div class="relative mb-6">
                    <div class="flex items-center border-2 border-blue-100 rounded-lg overflow-hidden focus-within:border-blue-500">
                        <span class="pl-4 text-gray-400">üîç</span>
                        <input type="text" id="prod-search" placeholder="Scan Barcode or Type Name..." class="w-full p-4 outline-none text-lg">
                    </div>
                    <div id="prod-results" class="absolute z-20 w-full bg-white shadow-xl border rounded mt-1 hidden max-h-60 overflow-y-auto"></div>
                </div>

                <div class="flex-grow overflow-y-auto border rounded-lg bg-gray-50">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100 text-xs text-gray-500 uppercase border-b sticky top-0">
                            <tr>
                                <th class="p-4">Product</th>
                                <th class="p-4 w-24">Price</th>
                                <th class="p-4 w-32 text-center">Qty</th>
                                <th class="p-4 w-24 text-right">Total</th>
                                <th class="p-4 w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="cart-body" class="bg-white"></tbody>
                    </table>
                    <div id="empty-cart" class="p-12 text-center text-gray-400 flex flex-col items-center justify-center h-48">
                        <span class="text-4xl mb-2">üõí</span>
                        <p>Cart is empty. Scan items to begin.</p>
                    </div>
                </div>

                <div class="border-t pt-6 mt-4 flex justify-between items-end">
                    <div class="text-gray-500 font-bold text-sm" id="item-count">0 Items</div>
                    <div class="text-right">
                        <div class="text-xs text-gray-400 uppercase font-bold mb-1">Grand Total</div>
                        <div class="text-4xl font-bold text-gray-800 mb-4" id="grand-total">$0.00</div>
                        <button onclick="submitOrder()" class="bg-green-600 hover:bg-green-700 text-white text-lg font-bold py-3 px-10 rounded shadow-lg transition transform hover:-translate-y-1">
                            Confirm Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://k10system.onrender.com/api';
        let currentType = 'In-Stock';
        let cart = [];

        document.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('k10_token')) window.location.href = 'admin.html';
            setupCustomerSearch();
            setupProductSearch();
            document.getElementById('cust-search').focus();
        });

        function setOrderType(type) {
            currentType = type;
            const btnStock = document.getElementById('btn-instock');
            const btnPre = document.getElementById('btn-preorder');
            const desc = document.getElementById('mode-desc');

            if (type === 'In-Stock') {
                btnStock.className = "flex-1 py-2 rounded-md text-sm font-bold shadow bg-white text-blue-600 ring-2 ring-blue-100";
                btnPre.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-500";
                desc.innerText = "Deducts from inventory immediately.";
            } else {
                btnPre.className = "flex-1 py-2 rounded-md text-sm font-bold shadow bg-white text-purple-600 ring-2 ring-purple-100";
                btnStock.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-500";
                desc.innerText = "Reserves items. Does NOT deduct active stock.";
            }
        }

        function setupCustomerSearch() {
            const input = document.getElementById('cust-search');
            let debounce;
            input.addEventListener('input', (e) => {
                clearTimeout(debounce);
                debounce = setTimeout(async () => {
                    const q = e.target.value;
                    if (q.length < 2) return document.getElementById('cust-results').classList.add('hidden');
                    
                    const res = await fetch(`${API_URL}/customers?search=${q}`);
                    const data = await res.json();
                    const div = document.getElementById('cust-results');
                    div.innerHTML = data.map(c => `
                        <div class="p-3 hover:bg-blue-50 cursor-pointer border-b flex justify-between" onclick='selectCustomer(${JSON.stringify(c)})'>
                            <div><div class="font-bold">${c.name}</div><div class="text-xs text-gray-500">${c.mobile_number || ''}</div></div>
                            <div class="text-xs font-bold text-blue-600">${c.loyalty_points || 0} pts</div>
                        </div>`).join('');
                    div.classList.remove('hidden');
                }, 300);
            });
        }

        function selectCustomer(c) {
            document.getElementById('selected-cust-id').value = c.id;
            document.getElementById('card-name').innerText = c.name;
            document.getElementById('card-info').innerText = c.mobile_number || c.email;
            document.getElementById('cust-points-badge').innerText = `${c.loyalty_points || 0} Pts`;
            document.getElementById('cust-search-container').classList.add('hidden');
            document.getElementById('cust-card').classList.remove('hidden');
        }

        function clearCustomer() {
            document.getElementById('selected-cust-id').value = '';
            document.getElementById('cust-search-container').classList.remove('hidden');
            document.getElementById('cust-card').classList.add('hidden');
        }

        function setupProductSearch() {
            const input = document.getElementById('prod-search');
            input.addEventListener('input', async (e) => {
                const q = e.target.value;
                if (q.length < 2) return document.getElementById('prod-results').classList.add('hidden');

                const res = await fetch(`${API_URL}/inventory/status`);
                const items = await res.json();
                
                const filtered = items.filter(i => 
                    i.card_name.toLowerCase().includes(q.toLowerCase()) || 
                    (i.barcode && i.barcode === q) ||
                    (i.card_id && i.card_id.toLowerCase().includes(q.toLowerCase()))
                );

                const div = document.getElementById('prod-results');
                div.innerHTML = filtered.map(i => `
                    <div class="p-3 hover:bg-blue-50 cursor-pointer border-b flex justify-between" onclick='addToCart(${JSON.stringify(i)})'>
                        <div>
                            <div class="font-bold">${i.card_name}</div>
                            <div class="text-xs text-gray-500 font-bold uppercase">${i.game_title} ‚Ä¢ ${i.category_name || 'Item'}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-green-600">$${i.price}</div>
                            <div class="text-xs">Stock: ${i.stock_quantity}</div>
                        </div>
                    </div>`).join('');
                div.classList.remove('hidden');
            });
        }

        function addToCart(item) {
            if (currentType === 'In-Stock' && item.stock_quantity <= 0) return alert("Out of stock!");
            const existing = cart.find(x => x.id === item.id);
            if (existing) existing.qty++;
            else cart.push({ id: item.id, name: item.card_name, price: parseFloat(item.price), qty: 1, max: item.stock_quantity });
            
            document.getElementById('prod-search').value = '';
            document.getElementById('prod-results').classList.add('hidden');
            renderCart();
        }

        function renderCart() {
            const tbody = document.getElementById('cart-body');
            document.getElementById('empty-cart').classList.toggle('hidden', cart.length > 0);
            let total = 0, count = 0;

            tbody.innerHTML = cart.map((item, idx) => {
                const sub = item.qty * item.price;
                total += sub; count += item.qty;
                return `
                <tr class="border-b">
                    <td class="p-4 font-bold text-sm">${item.name}</td>
                    <td class="p-4 text-gray-500">$${item.price.toFixed(2)}</td>
                    <td class="p-4 text-center">
                        <input type="number" min="1" value="${item.qty}" class="w-16 border rounded text-center" onchange="updateQty(${idx}, this.value)">
                    </td>
                    <td class="p-4 text-right font-bold">$${sub.toFixed(2)}</td>
                    <td class="p-4 text-right"><button onclick="removeFromCart(${idx})" class="text-red-400">√ó</button></td>
                </tr>`;
            }).join('');

            document.getElementById('grand-total').innerText = `$${total.toFixed(2)}`;
            document.getElementById('item-count').innerText = `${count} Items`;
        }

        function updateQty(idx, val) {
            const qty = parseInt(val);
            if (qty < 1) return;
            if (currentType === 'In-Stock' && qty > cart[idx].max) return alert("Insufficient stock!");
            cart[idx].qty = qty;
            renderCart();
        }

        function removeFromCart(idx) { cart.splice(idx, 1); renderCart(); }

        function toggleDepositInput() {
            document.getElementById('deposit-box').classList.toggle('hidden', document.getElementById('payment-status-select').value !== 'Partial');
        }

        async function submitOrder() {
            const custId = document.getElementById('selected-cust-id').value;
            if (!custId || cart.length === 0) return alert("Select customer and add items!");

            const payload = {
                customer_id: custId,
                order_type: currentType,
                payment_method: document.getElementById('payment-method').value,
                items: cart,
                custom_status: document.getElementById('payment-status-select').value,
                deposit_amount: document.getElementById('deposit-amount').value
            };

            const res = await fetch(`${API_URL}/sales`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (res.ok) { alert("Order Saved!"); location.reload(); }
        }
    </script>
</body>
</html>
